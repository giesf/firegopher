<!DOCTYPE html>
<html>

<head>
    <title>Architecture - firegopher</title>
    <link rel="stylesheet" href="https://unpkg.com/@highlightjs/cdn-assets@11.9.0/styles/default.min.css">
    <script src="https://unpkg.com/@highlightjs/cdn-assets@11.9.0/highlight.min.js"></script>
    <meta name="viewport" content="width=device-width, initial-scale=1" />

    <style>
        body {
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif, "Apple Color Emoji", "Segoe UI Emoji", "Segoe UI Symbol";
        }

        li.current {
            font-weight: bold;
        }

        img {
            max-width: 100%;

        }

        header p {
            font-size: 1.5rem;
            font-weight: bold;
        }

        main {
            max-width: 60rem;
            margin: 1rem auto;
            margin-bottom: 3rem;
        }

        blockquote {
            background: #e6e6e6;
            border-left: 4px #333 solid;
            margin-left: 0px;
            padding-left: 1.5rem;
            padding-top: 0.5rem;
            padding-bottom: 0.5rem;
        }

        .read-next {
            padding: 2rem 0rem;
            display: flex;
            justify-content: space-between;
        }
    </style>
</head>

<body>
    <main>
        <header>
            <p>firegopher <span style="color: #707070">/ docs</span></p>
        </header>
        
        <nav>
            <ul>
                
                
                <li class="">
                    <a href="..">What is firegopher?</a>
                </li>
                
                
                
                <li class="">
                    <a href="../1-getting-started/">Getting Started</a>
                </li>
                
                
                
                <li class="">
                    <a href="../2-user-guide/">User Guide</a>
                </li>
                
                
                
                <li class="current">
                    <a href="./">Architecture</a>
                </li>
                
                
                
                <li class="">
                    <a href="../4-known-limitations/">Known limitations</a>
                </li>
                
                
                
                <li class="">
                    <a href="../5-roadmap/">Roadmap</a>
                </li>
                
                
                
                <li class="">
                    <a href="../6-contributing/">Contributing</a>
                </li>
                
                
            </ul>
        </nav>
        
        <h1 id="architecture">Architecture</h1>
<p>The firegopher project is made up of three main parts:</p>
<ol>
<li>The <strong>VM Runner</strong>, which prepares the host system and starts the guest VM</li>
<li>The <strong>Guest Init System</strong>, which runs inside of the guest VM and starts the user workload</li>
<li>A set of customised root filesystems (<a href="#base-images">Base Images</a>) to be used for the guest VM and an <strong>Asset Manager</strong> to install and manage them</li>
</ol>
<p><img alt="Relationship of the different modules" src="../assets/RELATIONSHIPS.jpg" /></p>
<h2 id="vm-runner">VM Runner</h2>
<p>The VM Runner has four main responsibilities:</p>
<ol>
<li>It prepares the root file system for the guest VM<ul>
<li>by unpacking the user assets into a copy of the chosen <a href="#base-images">Base Image</a></li>
<li>and creating a configuration file that instructs the <a href="#guest-init-system">Guest Init System</a> on what to do with them</li>
</ul>
</li>
<li>It prepares the <a href="https://github.com/firecracker-microvm/firecracker/blob/main/docs/jailer.md">Firecracker Jail</a> <ul>
<li>by first creating a directory that will later be used by the Firecracker Jailer as a <a href="https://wiki.archlinux.org/title/chroot">CHROOT root directory</a></li>
<li>and copying/hardlinking all the assets that are needed to run the guest VM into it</li>
</ul>
</li>
<li>It creates and configures the network device needed for the guest VM</li>
<li>It starts the jailed Firecracker process and supervises it</li>
</ol>
<h2 id="guest-init-system">Guest Init System</h2>
<p>The Guest Init System is a barebones init system specifically designed to run a single application inside of a VM. At its core it is a go-rewrite of <a href="https://github.com/superfly/init-snapshot">fly-init-snapshot</a>.</p>
<p>The main responsibilities of the guest init system are:</p>
<ol>
<li>reading the configuration passed to it from the VM Runner</li>
<li>mounting the root file system</li>
<li>mounting all the required <a href="https://en.wikipedia.org/wiki/Device_file">device files</a></li>
<li>configuring the network interface</li>
<li>dropping root privileges</li>
<li>starting the user workload and supervising it</li>
</ol>
<h2 id="networking">Networking</h2>
<p>The current networking setup is in its very early-stages and should not be considered stable.</p>
<p>Firegopher is designed to be used with a reverse proxy on the host machine that routes incoming traffic to the different running microVMs. In the future Firegopher will automatically configure a reverse proxy based on the users needs. Currently users need to configure a reverse proxy manually.</p>
<p>Currently every microVM is automatically assigned a non-internet-routable IP in the range 172.19.0.0/16. The host system is instructed to forward all traffic from the microVM to the internet.</p>
<p><img alt="Network topology" src="../assets/NETWORKING.jpg" /></p>
<h2 id="asset-manager">Asset Manager</h2>
<p>The Asset Manager is currently in the early stages of its development. In its current state it is little more than a glorified download script. </p>
<p>It downloads the following assets:</p>
<ol>
<li>A Linux Kernel Image</li>
<li>A specific version of Firecracker (currently 1.6.0)</li>
<li>A modified version of the Ubuntu 22.04 root file system</li>
</ol>
<h2 id="base-images">Base Images</h2>
<p>Currently there is only one officially supported base image available to be used with firegopher. It is a slightly modified version of <a href="https://cloud-images.ubuntu.com/minimal/releases/jammy/release/">Ubuntu 22.04 Minimal</a>. The modifications that are currently done to create the finished base image are:</p>
<ol>
<li>Installing <code>ca-certificates</code>, <code>curl</code> and <code>python3</code></li>
<li>Clearing out the existing package lists afterwards by deleting all files in <code>/var/lib/apt/lists/</code></li>
</ol>
<p>The current base image creation process is heavily based on the process <a href="https://github.com/firecracker-microvm/firecracker/blob/main/docs/rootfs-and-kernel-setup.md#creating-a-rootfs-image">outlined by the Firecracker team here</a>.</p>

        <div class="read-next">
            <a href="/2-user-guide/">Previous: User Guide</a>
            <a href="/4-known-limitations/">Next: Known limitations</a>
        </div>
        <script src="../search/main.js"></script>
    </main>

    <script>hljs.highlightAll();</script>
</body>

</html>